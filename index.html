<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR - Sticky Object</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      AFRAME.registerComponent('sticky-object', {
        init: function () {
          this.markerFound = false;
          const marker = document.querySelector('a-marker');
          const object = this.el;

          marker.addEventListener('markerFound', () => {
            if (!this.markerFound) {
              // 初回検知時のみ実行
              // マーカーの現在の世界座標（World Position）を取得
              const worldPos = new THREE.Vector3();
              const worldQuat = new THREE.Quaternion();
              const worldScale = new THREE.Vector3();
              
              object.object3D.getWorldPosition(worldPos);
              object.object3D.getWorldQuaternion(worldQuat);
              object.object3D.getWorldScale(worldScale);

              // オブジェクトをマーカーから切り離し、シーン（a-scene）直下へ移動
              this.el.sceneEl.appendChild(object);

              // 取得した世界座標を再設定
              object.object3D.position.copy(worldPos);
              object.object3D.quaternion.copy(worldQuat);
              object.object3D.scale.copy(worldScale);

              this.markerFound = true; // 固定完了
              console.log("Object Fixed in World Space");
            }
          });
        }
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
      
      <a-marker preset="hiro">
        <a-box id="myBox" position="0 0.5 0" material="color: blue; opacity: 0.8;"
               animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
               sticky-object>
        </a-box>
      </a-marker>

      <a-entity camera></a-entity>
      
    </a-scene>
  </body>
</html>