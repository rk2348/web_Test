<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR - Fixed Clone</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      AFRAME.registerComponent('marker-fixer', {
        init: function () {
          this.done = false;
          const marker = this.el; // a-marker
          const target = document.querySelector('#sticky-box'); // 追跡する箱

          marker.addEventListener('markerFound', () => {
            if (this.done) return;

            // 安定するまでわずかに待機（0.1秒）
            setTimeout(() => {
              // 1. 世界座標・回転・スケールを取得
              const worldPos = new THREE.Vector3();
              const worldQuat = new THREE.Quaternion();
              const worldScale = new THREE.Vector3();
              
              target.object3D.getWorldPosition(worldPos);
              target.object3D.getWorldQuaternion(worldQuat);
              target.object3D.getWorldScale(worldScale);

              // 2. 新しい箱を生成（クローン）
              const clone = document.createElement('a-box');
              
              // 3. 属性をコピー（見た目やアニメーション）
              clone.setAttribute('material', target.getAttribute('material'));
              clone.setAttribute('animation', target.getAttribute('animation'));
              clone.setAttribute('scale', target.getAttribute('scale'));
              
              // 4. シーンに直接追加（マーカーの外に出す）
              const scene = document.querySelector('a-scene');
              scene.appendChild(clone);

              // 5. 取得した世界座標をセット
              clone.object3D.position.copy(worldPos);
              clone.object3D.quaternion.copy(worldQuat);
              // スケールも維持したい場合はこちら
              // clone.object3D.scale.copy(worldScale);

              // 6. 元の（マーカー内の）箱は消す
              target.setAttribute('visible', false);

              this.done = true;
              console.log("固定オブジェクトを生成しました");
            }, 100);
          });
        }
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <a-marker preset="hiro" marker-fixer>
        <a-box id="sticky-box" position="0 0.5 0" 
               material="color: blue; opacity: 0.8;"
               animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
        </a-box>
      </a-marker>

      <a-entity camera></a-entity>
      
    </a-scene>
  </body>
</html>