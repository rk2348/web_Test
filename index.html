<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR - Sticky Object Improved</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      AFRAME.registerComponent('sticky-object', {
        init: function () {
          this.markerFound = false;
          const marker = document.querySelector('a-marker');
          const object = this.el;

          marker.addEventListener('markerFound', () => {
            if (this.markerFound) return;

            // 100ミリ秒だけ待ってから位置を固定（追跡が安定するのを待つ）
            setTimeout(() => {
              // 現在の世界座標・回転・スケールを強制的に更新して取得
              const worldMatrix = new THREE.Matrix4();
              object.object3D.updateMatrixWorld(true); 
              worldMatrix.copy(object.object3D.matrixWorld);

              // オブジェクトをマーカーから切り離し、シーン直下へ移動
              const sceneEl = document.querySelector('a-scene');
              sceneEl.appendChild(object);

              // 取得した行列を新しい親（シーン）に対して適用
              object.object3D.matrix.copy(worldMatrix);
              object.object3D.matrix.decompose(object.object3D.position, object.object3D.quaternion, object.object3D.scale);

              this.markerFound = true;
              console.log("Object fixed!");
            }, 100); 
          });
        }
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <a-marker preset="hiro">
        <a-box position="0 0.5 0" 
               material="color: blue; opacity: 0.8;"
               animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
               sticky-object>
        </a-box>
      </a-marker>

      <a-entity camera></a-entity>
      
    </a-scene>
  </body>
</html>